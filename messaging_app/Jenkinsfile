pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'github-credentials',
                    usernameVariable: 'GIT_USERNAME',
                    passwordVariable: 'GIT_PASSWORD'
                )]) {
                    sh '''
                        git clone https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/lsd1code/alx-backen-python.git
                    '''
                }
            }
        }
        
        stage('Set Up Python') {
            steps {
                sh 'python3 -m venv venv'
                sh '. venv/bin/activate'
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh '''
                    . venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                    pip install pytest pytest-django pytest-html
                '''
            }
        }
        
        stage('Run Tests') {
            steps {
                sh '''
                    . venv/bin/activate
                    python manage.py test --no-input || true # Fallback for Django tests
                    pytest --junitxml=test-results.xml --html=test-report.html -v || true
                '''
            }
            post {
                always {
                    junit 'test-results.xml'
                    publishHTML target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'test-report.html',
                        reportName: 'Pytest HTML Report'
                    ]
                }
            }
        }
    }
    
    post {
        always {
            sh 'rm -rf venv'
        }
    }
}