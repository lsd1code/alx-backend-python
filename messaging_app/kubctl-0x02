#!/usr/bin/env bash
set -euo pipefail

kubectl apply -f kubeservice.yaml

for version in blue green; do
  echo "=== checking version: $version ==="

  kubectl wait --for=condition=Ready pod -l "app=messaging-app,version=$version" --timeout=60s 2>/dev/null || true

  pods=$(kubectl get pods -l "app=messaging-app,version=$version" -o jsonpath='{.items[*].metadata.name}')
  
  if [ -z "$pods" ]; then
    echo "No pods found for version=$version"
    continue
  fi

  for p in $pods; do
    echo "--- logs for $p ---"
    kubectl logs "$p" --tail=200 || true
    if kubectl logs "$p" --tail=200 2>/dev/null | grep -i -E "error|exception" >/dev/null; then
      echo "Errors detected in pod $p"
    else
      echo "No errors found in pod $p"
    fi
  done
done
